name: Update Downloads Badge

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [main]
    paths: ['.github/workflows/update-downloads-badge.yml']

jobs:
  update-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get download count
        id: downloads
        run: |
          # Fetch the package page and extract total download count
          PAGE_CONTENT=$(curl -s "https://github.com/C2gl/tududi_addon/pkgs/container/tududi-addon")
          
          # Look for the "Total downloads" section and extract the number
          DOWNLOAD_COUNT=$(echo "$PAGE_CONTENT" | \
            grep -A 3 -B 3 "Total downloads" | \
            grep -o '[0-9,]\+' | \
            tr -d ',' | \
            head -1)
          
          # Alternative method: look for the downloads section in the page structure
          if [ -z "$DOWNLOAD_COUNT" ] || [ "$DOWNLOAD_COUNT" = "0" ]; then
            DOWNLOAD_COUNT=$(echo "$PAGE_CONTENT" | \
              sed -n '/Total downloads/,/[0-9]/p' | \
              grep -o '[0-9,]\+' | \
              tr -d ',' | \
              head -1)
          fi
          
          # Another fallback: look for the specific HTML pattern
          if [ -z "$DOWNLOAD_COUNT" ] || [ "$DOWNLOAD_COUNT" = "0" ]; then
            DOWNLOAD_COUNT=$(echo "$PAGE_CONTENT" | \
              grep -oP '(?<=Total downloads[^0-9]*)[0-9,]+' | \
              tr -d ',' | \
              head -1)
          fi
          
          # Final fallback: use a more lenient pattern
          if [ -z "$DOWNLOAD_COUNT" ] || [ "$DOWNLOAD_COUNT" = "0" ]; then
            DOWNLOAD_COUNT=$(echo "$PAGE_CONTENT" | \
              grep -A 10 "Total downloads" | \
              grep -o '[0-9]\+' | \
              sort -nr | \
              head -1)
          fi
          
          # Ensure we have a valid number, use current badge value as fallback
          if ! [[ "$DOWNLOAD_COUNT" =~ ^[0-9]+$ ]] || [ "$DOWNLOAD_COUNT" = "0" ]; then
            # Extract current value from README as fallback
            CURRENT_COUNT=$(grep -o "downloads-[0-9]\+" README.md | grep -o "[0-9]\+" | head -1)
            DOWNLOAD_COUNT=${CURRENT_COUNT:-"121"}
          fi
          
          echo "count=$DOWNLOAD_COUNT" >> $GITHUB_OUTPUT
          echo "游닌 Total Downloads Found: $DOWNLOAD_COUNT"
          
          # Debug: Show what we found in the page
          echo "Debug - Total downloads context:"
          echo "$PAGE_CONTENT" | grep -A 5 -B 5 "Total downloads" || echo "Pattern not found"
      
      - name: Update README badge
        run: |
          # Update the downloads badge in README.md
          sed -i "s/downloads-[0-9]\+/downloads-${{ steps.downloads.outputs.count }}/g" README.md
          
          # Check if anything was changed
          if git diff --quiet README.md; then
            echo "No changes needed"
            echo "changed=false" >> $GITHUB_ENV
          else
            echo "Badge updated with ${{ steps.downloads.outputs.count }} downloads"
            echo "changed=true" >> $GITHUB_ENV
          fi
      
      - name: Create Pull Request
        if: env.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "游닌 Update downloads badge: ${{ steps.downloads.outputs.count }} downloads"
          title: "游닌 Update downloads badge: ${{ steps.downloads.outputs.count }} downloads"
          body: |
            ## 游닌 Downloads Badge Update
            
            This PR automatically updates the downloads badge in the README with the latest download count from GitHub Container Registry.
            
            **Current downloads:** ${{ steps.downloads.outputs.count }}
            
            ---
            *This PR was created automatically by the update-downloads-badge workflow.*
          branch: update-downloads-badge
          delete-branch: true
          base: main
          committer: GitHub Action <action@github.com>
          author: GitHub Action <action@github.com>