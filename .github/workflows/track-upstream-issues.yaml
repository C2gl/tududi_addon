name: üîç Track Upstream Issues

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-upstream:
    name: Check Upstream Issues
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Track Upstream Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all open issues with "Upstream?" label
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'Upstream?',
              per_page: 100
            });
            
            console.log(`Found ${issues.length} open issues with 'Upstream?' label`);
            
            // Regex to match GitHub issue references (owner/repo#number or chrisvel/tududi#466)
            const issueRefRegex = /(?:https?:\/\/github\.com\/)?([a-zA-Z0-9_-]+)\/([a-zA-Z0-9_-]+)(?:\/(?:issues|discussions)\/|#)(\d+)/g;
            
            // Helper function to check if upstream issue/discussion is closed
            async function checkUpstreamStatus(upstreamOwner, upstreamRepo, upstreamNumber) {
              // First, try as an issue
              try {
                const { data: upstreamIssue } = await github.rest.issues.get({
                  owner: upstreamOwner,
                  repo: upstreamRepo,
                  issue_number: upstreamNumber
                });
                
                return {
                  found: true,
                  type: 'issue',
                  state: upstreamIssue.state,
                  closedAt: upstreamIssue.closed_at,
                  url: upstreamIssue.html_url
                };
              } catch (issueError) {
                // If 404, it might be a discussion, try GraphQL
                if (issueError.status === 404) {
                  try {
                    const query = `
                      query($owner: String!, $repo: String!, $number: Int!) {
                        repository(owner: $owner, name: $repo) {
                          discussion(number: $number) {
                            id
                            number
                            title
                            closed
                            closedAt
                            url
                          }
                        }
                      }
                    `;
                    
                    const result = await github.graphql(query, {
                      owner: upstreamOwner,
                      repo: upstreamRepo,
                      number: parseInt(upstreamNumber)
                    });
                    
                    if (result.repository.discussion) {
                      return {
                        found: true,
                        type: 'discussion',
                        state: result.repository.discussion.closed ? 'closed' : 'open',
                        closedAt: result.repository.discussion.closedAt,
                        url: result.repository.discussion.url
                      };
                    }
                  } catch (discussionError) {
                    console.log(`    Could not fetch as discussion: ${discussionError.message}`);
                  }
                }
                
                return {
                  found: false,
                  error: issueError
                };
              }
            }
            
            for (const issue of issues) {
              const issueNumber = issue.number;
              const issueBody = issue.body || '';
              const issueTitle = issue.title || '';
              const combinedText = `${issueTitle}\n${issueBody}`;
              
              console.log(`\nProcessing issue #${issueNumber}: ${issueTitle}`);
              
              // Find all upstream issue references
              const matches = [...combinedText.matchAll(issueRefRegex)];
              
              if (matches.length === 0) {
                console.log(`  No upstream references found`);
                continue;
              }
              
              for (const match of matches) {
                const upstreamOwner = match[1];
                const upstreamRepo = match[2];
                const upstreamIssueNumber = match[3];
                
                console.log(`  Found reference: ${upstreamOwner}/${upstreamRepo}#${upstreamIssueNumber}`);
                
                const upstreamStatus = await checkUpstreamStatus(upstreamOwner, upstreamRepo, upstreamIssueNumber);
                
                if (!upstreamStatus.found) {
                  console.log(`  ‚ö†Ô∏è Could not find upstream issue/discussion`);
                  
                  const { data: comments } = await github.rest.issues.listComments({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    per_page: 100
                  });
                  
                  const botAlreadyCommented = comments.some(comment => 
                    comment.user.type === 'Bot' && 
                    comment.body.includes(`${upstreamOwner}/${upstreamRepo}#${upstreamIssueNumber}`) &&
                    comment.body.includes('not found')
                  );
                  
                  if (!botAlreadyCommented) {
                    await github.rest.issues.createComment({
                      owner,
                      repo,
                      issue_number: issueNumber,
                      body: `‚ö†Ô∏è **Upstream Update**\n\n` +
                            `The upstream ${upstreamOwner}/${upstreamRepo}#${upstreamIssueNumber} ` +
                            `could not be found. It may have been deleted or made private.\n\n` +
                            `@${owner} Please verify the upstream reference.`
                    });
                    
                    console.log(`  ‚ö†Ô∏è Posted warning comment`);
                  }
                  continue;
                }
                
                console.log(`  Upstream ${upstreamStatus.type} state: ${upstreamStatus.state}`);
                
                if (upstreamStatus.state === 'closed') {
                  // Check if we already commented about this
                  const { data: comments } = await github.rest.issues.listComments({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    per_page: 100
                  });
                  
                  const botAlreadyCommented = comments.some(comment => 
                    comment.user.type === 'Bot' && 
                    comment.body.includes(`${upstreamOwner}/${upstreamRepo}#${upstreamIssueNumber}`) &&
                    comment.body.includes('has been closed')
                  );
                  
                  if (!botAlreadyCommented) {
                    // Post a comment notifying about the closure
                    const closedAt = upstreamStatus.closedAt 
                      ? new Date(upstreamStatus.closedAt).toLocaleDateString()
                      : 'recently';
                    
                    await github.rest.issues.createComment({
                      owner,
                      repo,
                      issue_number: issueNumber,
                      body: `üéâ **Upstream Update**\n\n` +
                            `The upstream ${upstreamStatus.type} [${upstreamOwner}/${upstreamRepo}#${upstreamIssueNumber}](${upstreamStatus.url}) ` +
                            `has been closed on ${closedAt}.\n\n` +
                            `@${owner} This issue may now be ready to work on!`
                    });
                    
                    console.log(`  ‚úÖ Posted notification comment`);
                  } else {
                    console.log(`  ‚ÑπÔ∏è Already notified about this closure`);
                  }
                }
              }
            }
            
            console.log('\n‚úÖ Upstream tracking complete');
